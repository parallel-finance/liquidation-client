AWSTemplateFormatVersion: '2010-09-09'

Parameters:
  PagerDutyIntegrationKey:
    Description: The CloudWatch integration key that generated by PagerDuty
    Type: String
  ServiceName:
    Type: String
    Default: "liquidation-client"
  ChainName:
    Type: String

Resources:
  ScannerJobDidNotRunAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmDescription: Trigger the PD alert when the scanner job is not alive.
      Namespace: !Ref ServiceName
      MetricName: scanner-new-round
      Statistic: Minimum
      Period: '300'
      EvaluationPeriods: '3'
      ComparisonOperator: LessThanThreshold
      Threshold: '0'
      InsufficientDataActions:
        - !Ref PagerDutyTopic
      OKActions:
        - !Ref PagerDutyTopic
      Dimensions:
      - Name: Chain
        Value: !Ref ChainName

  LiquidateJobDidNotRunAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmDescription: Trigger the PD alert when the liquidate job is not alive.
      Namespace: !Ref ServiceName
      MetricName: liquidate-new-round
      Statistic: Minimum
      Period: '300'
      EvaluationPeriods: '3'
      ComparisonOperator: LessThanThreshold
      Threshold: '0'
      InsufficientDataActions:
        - !Ref PagerDutyTopic
      OKActions:
        - !Ref PagerDutyTopic
      Dimensions:
      - Name: Chain
        Value: !Ref ChainName

  LiquidateShortfallTooBigAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmDescription: Trigger the PD alert when the liquidate shortfall too big.
      Namespace: !Ref ServiceName
      MetricName: shortfall-too-big
      Statistic: Maximum
      Period: '300'
      EvaluationPeriods: '3'
      ComparisonOperator: GreaterThanThreshold
      Threshold: '?'
      InsufficientDataActions:
        - !Ref PagerDutyTopic
      OKActions:
        - !Ref PagerDutyTopic
      Dimensions:
      - Name: Chain
        Value: !Ref ChainName

  PagerDutyTopic:
    Type: AWS::SNS::Topic
    Properties:
      Subscription:
        - Endpoint: !Sub "https://events.pagerduty.com/integration/${PagerDutyIntegrationKey}/enqueue"
          Protocol: "HTTPS"
